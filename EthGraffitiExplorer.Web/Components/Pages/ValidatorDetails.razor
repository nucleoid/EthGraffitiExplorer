@page "/validator/{validatorIndex:int}"
@using EthGraffitiExplorer.Core.DTOs
@using EthGraffitiExplorer.Web.Services
@inject GraffitiApiClient ApiClient

<PageTitle>Validator @ValidatorIndex</PageTitle>

<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Home</a></li>
            <li class="breadcrumb-item active">Validator @ValidatorIndex</li>
        </ol>
    </nav>

    @if (loading)
    {
        <div class="text-center my-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (validator != null)
    {
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">Validator @validator.ValidatorIndex</h3>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-3">Public Key:</dt>
                    <dd class="col-sm-9"><code class="small">@validator.Pubkey</code></dd>

                    <dt class="col-sm-3">Status:</dt>
                    <dd class="col-sm-9">
                        <span class="badge @(validator.IsActive ? "bg-success" : "bg-secondary")">
                            @(validator.IsActive ? "Active" : "Inactive")
                        </span>
                    </dd>

                    <dt class="col-sm-3">Effective Balance:</dt>
                    <dd class="col-sm-9">@((validator.EffectiveBalance / 1_000_000_000.0).ToString("N2")) ETH</dd>

                    @if (validator.ActivationEpoch.HasValue)
                    {
                        <dt class="col-sm-3">Activation Epoch:</dt>
                        <dd class="col-sm-9">@validator.ActivationEpoch</dd>
                    }

                    @if (validator.ExitEpoch.HasValue && validator.ExitEpoch.Value != long.MaxValue)
                    {
                        <dt class="col-sm-3">Exit Epoch:</dt>
                        <dd class="col-sm-9">@validator.ExitEpoch</dd>
                    }

                    <dt class="col-sm-3">Total Graffiti:</dt>
                    <dd class="col-sm-9">@validator.GraffitiCount</dd>
                </dl>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Graffiti History</h5>
            </div>
            <div class="card-body">
                @if (graffitis != null && graffitis.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Slot</th>
                                    <th>Graffiti</th>
                                    <th>Timestamp</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var graffiti in graffitis)
                                {
                                    <tr>
                                        <td><code>@graffiti.Slot</code></td>
                                        <td>
                                            <span class="badge bg-light text-dark" title="@graffiti.RawGraffiti">
                                                @graffiti.DecodedGraffiti
                                            </span>
                                        </td>
                                        <td>@graffiti.Timestamp.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <p class="text-muted">No graffiti found for this validator.</p>
                }
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i> Validator not found.
        </div>
    }
</div>

@code {
    [Parameter]
    public int ValidatorIndex { get; set; }

    private ValidatorDto? validator;
    private List<GraffitiDto>? graffitis;
    private bool loading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadValidatorData();
    }

    private async Task LoadValidatorData()
    {
        loading = true;
        try
        {
            validator = await ApiClient.GetValidatorByIndexAsync(ValidatorIndex);
            graffitis = await ApiClient.GetGraffitiByValidatorAsync(ValidatorIndex);
        }
        finally
        {
            loading = false;
        }
    }
}
